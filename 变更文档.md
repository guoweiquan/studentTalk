# 变更文档

## 变更日期：2026-02-01（v1.8）

---

## 一、设计方案更新（v1.7 → v1.8）

### 1.1 页面合并：记录详情与新增记录

**变更说明**：将原独立的"记录详情页"合并到"新增记录页"，通过页面模式实现查看、编辑、新增三种功能

#### 页面模式

| 模式 | URL参数 | 触发方式 | 表单状态 | 底部按钮 |
| :--- | :--- | :--- | :--- | :--- |
| 新增模式 | 无 | 底部导航进入 | 所有字段可编辑 | [提交保存] |
| 查看模式 | `id` + `mode=view` | 列表点击记录 | 所有字段只读 | [编辑记录] [删除记录] |
| 编辑模式 | `id` + `mode=edit` | 查看模式点击编辑 | 部分字段可编辑 | [取消] [保存] |

#### 编辑模式字段规则

| 字段 | 查看模式 | 编辑模式 | 新增模式 | 说明 |
|------|---------|---------|---------|------|
| 学生姓名 | 只读 | **只读** | 可编辑 | 基础信息不可修改 |
| 学号 | 只读 | **只读** | 可编辑 | 基础信息不可修改 |
| 班级 | 只读 | **只读** | 可编辑 | 基础信息不可修改 |
| 谈话地点 | 只读 | **只读** | 可编辑 | 基础信息不可修改 |
| 谈话时间 | 只读 | **只读** | 可编辑 | 基础信息不可修改 |
| 其他字段 | 只读 | 可编辑 | 可编辑 | 包括标签、风险等级、谈话记录等 |

#### 影响范围

**设计文档变更**：
- `设计方案v1.1.md`：版本号更新为v1.8
- 3.1 新增记录页：新增页面模式说明、编辑模式字段规则
- 3.3 记录详情页：标注已合并，说明跳转逻辑
- 5.2 接口列表：强调 PUT /record/:id 接口

**后端代码变更**：
- `backend/src/app/api/v1/record/[id]/route.ts`：新增 PUT 方法实现记录更新

**前端代码变更**：
- `frontend/src/api/index.ts`：新增 `updateRecord` 函数
- `frontend/src/pages/record-add/index.vue`：
  - 新增 `mode` 响应式变量（查看/编辑/新增）
  - 新增 `recordId` 响应式变量（当前记录ID）
  - 新增 `isFieldDisabled` 函数（判断字段是否禁用）
  - 新增 `loadRecordDetail` 函数（加载记录详情）
  - 新增 `handleEdit` 函数（切换到编辑模式）
  - 新增 `handleDelete` 函数（删除记录）
  - 新增 `handleCancel` 函数（取消编辑）
  - 修改 `handleSubmit` 函数（支持新增/更新）
  - 底部按钮区域条件渲染
  - 表单字段动态设置 `disabled` 属性
- `frontend/src/pages/record-list/index.vue`：
  - 修改 `goToDetail` 函数跳转路径为 `/pages/record-add/index?id=xxx&mode=view`
- `frontend/src/pages/record-detail/index.vue`：标记为废弃（可选删除）

---

## 变更日期：2026-01-31（v1.7）

---

## 一、设计方案更新（v1.6 → v1.7）

### 1.1 新增搜索联想功能

**变更说明**：在记录列表页的搜索框中，输入学生姓名时实时从数据库获取匹配的学生姓名列表

#### 功能特性

| 特性 | 说明 |
| :--- | :--- |
| 防抖处理 | 输入后延迟300ms再发起请求 |
| 去重显示 | 返回的学生姓名去重后显示 |
| 模糊匹配 | 支持姓名任意位置匹配 |
| 结果限制 | 最多显示10条建议 |
| 交互体验 | 点击联想项填入搜索框并执行搜索 |

#### 后端 API 新增

| 接口 | 方法 | 路径 | 参数 |
| :--- | :--- | :--- | :--- |
| 学生姓名联想 | GET | `/api/v1/record/suggest` | `keyword`: 搜索关键字 |

**SQL 查询逻辑**：
```sql
SELECT DISTINCT student_name 
FROM talk_record 
WHERE student_name LIKE '%关键字%'
ORDER BY student_name
LIMIT 10;
```

#### 影响范围

**后端代码变更**：
- 新增 `backend/src/app/api/v1/record/suggest/route.ts`：学生姓名联想 API

**前端代码变更**：
- `frontend/src/api/index.ts`：新增 `getStudentSuggestions` 函数
- `frontend/src/pages/record-list/index.vue`：
  - 新增 `suggestions` 响应式变量（联想结果列表）
  - 新增 `showSuggestions` 响应式变量（控制下拉显示）
  - 新增 `debounce` 工具函数（防抖处理）
  - 新增联想下拉组件及样式
  - 新增 `handleInputChange` 函数（处理输入变化）
  - 新增 `selectSuggestion` 函数（选择联想项）

---

### 1.2 记录列表单行展示

**变更说明**：将记录列表中每条记录从原来的3行展示压缩为1行展示

#### 变更前后对比

**变更前（3行）**：
```
┌──────────────────────────────────────┐
│ 王老五                     2026-01-30 │  ← 第1行
│ 打架                         六年级3班 │  ← 第2行
│ 中风险                                │  ← 第3行
└──────────────────────────────────────┘
```

**变更后（1行）**：
```
│ 王老五 │ 打架 │ 🟡中 │ 六年3班 │ 01-30 │
```

#### 字段显示顺序

| 优先级 | 字段 | 显示处理 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | 学生姓名 | 最多4字，超出截断 | 主要标识 |
| 2 | 事由 | 最多4字，超出截断 | 快速了解谈话原因 |
| 3 | 风险等级 | 彩色圆点+单字 | 🟢低 / 🟡中 / 🔴高 |
| 4 | 年级班级 | 简写显示 | 如"六年3班" |
| 5 | 日期 | MM-DD格式 | 省略年份 |

#### 影响范围

**前端代码变更**：
- `frontend/src/pages/record-list/index.vue`：
  - 重构列表项模板结构（从多行改为单行 flex 布局）
  - 新增 `formatDate` 函数（格式化日期为 MM-DD）
  - 新增 `getRiskIcon` 函数（返回风险等级对应的图标）
  - 新增 `truncateText` 函数（文本截断处理）
  - 更新 CSS 样式（单行布局、响应式适配）

---

（以下保留原有的v1.6及更早版本的变更记录...）
