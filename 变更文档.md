# å˜æ›´æ–‡æ¡£

## å˜æ›´æ—¥æœŸï¼š2026-01-27

---

## ä¸€ã€å¯åŠ¨æ–‡æ¡£æ›´æ–°

### 1.1 æ–‡ä»¶ï¼š`å¯åŠ¨æ­¥éª¤.md`

**å˜æ›´å†…å®¹**ï¼šæ–°å¢ç¬¬4æ­¥"å¯åŠ¨å¾®ä¿¡å°ç¨‹åºå¼€å‘æœåŠ¡"

**æ–°å¢å†…å®¹**ï¼š

```markdown
## 4. å¯åŠ¨å¾®ä¿¡å°ç¨‹åºå¼€å‘æœåŠ¡
æ‰“å¼€æ–°ç»ˆç«¯ï¼Œè¿›å…¥å‰ç«¯ç›®å½•ï¼š

```powershell
cd d:\Code_Repository\studentTalk\frontend
```

å®‰è£…ä¾èµ–ï¼ˆè‹¥æœªå®‰è£…ï¼‰ï¼š

```powershell
npm install
```

å¯åŠ¨å¾®ä¿¡å°ç¨‹åºå¼€å‘æœåŠ¡ï¼š

```powershell
npm run dev:mp-weixin
```

ç¼–è¯‘å®Œæˆåï¼Œä¼šåœ¨ `dist/dev/mp-weixin` ç›®å½•ç”Ÿæˆå°ç¨‹åºä»£ç ã€‚

### ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·

1. æ‰“å¼€ **å¾®ä¿¡å¼€å‘è€…å·¥å…·**
2. é€‰æ‹© **ã€Œå¯¼å…¥é¡¹ç›®ã€**
3. ç›®å½•é€‰æ‹©ï¼š`d:\Code_Repository\studentTalk\frontend\dist\dev\mp-weixin`
4. å¡«å…¥æ‚¨çš„å°ç¨‹åº AppIDï¼ˆæˆ–é€‰æ‹©æµ‹è¯•å·ï¼‰
5. ç‚¹å‡» **ã€Œå¯¼å…¥ã€** å®Œæˆ

> ğŸ’¡ æç¤ºï¼šä¿®æ”¹ä»£ç åä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘ï¼Œå¾®ä¿¡å¼€å‘è€…å·¥å…·ä¼šè‡ªåŠ¨åˆ·æ–°é¢„è§ˆã€‚

### æœ¬åœ°è®¾ç½®ï¼ˆå¼€å‘é˜¶æ®µï¼‰

ä¸ºäº†æ–¹ä¾¿æœ¬åœ°å¼€å‘è°ƒè¯•ï¼š
1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ç‚¹å‡» **ã€Œè¯¦æƒ…ã€**
2. åˆ‡æ¢åˆ° **ã€Œæœ¬åœ°è®¾ç½®ã€**
3. å‹¾é€‰ âœ… **ã€Œä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewï¼ˆä¸šåŠ¡åŸŸåï¼‰ã€TLS ç‰ˆæœ¬ä»¥åŠ HTTPS è¯ä¹¦ã€**

### ç”Ÿäº§æ„å»º

å¦‚éœ€æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼š

```powershell
npm run build:mp-weixin
```

æ„å»ºåçš„ä»£ç ä½äº `dist/build/mp-weixin`ï¼Œå¯ç”¨äºä¸Šä¼ å‘å¸ƒã€‚
```

**åŒæ—¶æ›´æ–°"è®¿é—®åœ°å€"éƒ¨åˆ†**ï¼Œæ–°å¢ï¼š
- å¾®ä¿¡å°ç¨‹åºï¼šé€šè¿‡å¾®ä¿¡å¼€å‘è€…å·¥å…·é¢„è§ˆ

---

## äºŒã€API é…ç½®ä¿®æ”¹

### 2.1 æ–‡ä»¶ï¼š`frontend/src/api/index.ts`

**é—®é¢˜**ï¼š
1. å°ç¨‹åºæ— æ³•è¯†åˆ« localhostï¼Œéœ€è¦ä½¿ç”¨ IP åœ°å€
2. IP åœ°å€ `192.168.0.101` ä¸å®é™…ç”µè„‘ IP `192.168.0.103` ä¸åŒ¹é…
3. å¤–ç½‘è®¿é—®æ—¶ï¼ŒHTTPS é¡µé¢è¯·æ±‚ HTTP èµ„æºå¯¼è‡´ Mixed Content é”™è¯¯

**ä¿®æ”¹å†…å®¹**ï¼š

```typescript
// ä¿®æ”¹å‰
const BASE_URL = 'http://192.168.0.101:3000/api/v1';

// ä¿®æ”¹åï¼ˆå¤–ç½‘è®¿é—®ç‰ˆæœ¬ï¼‰
const BASE_URL = 'https://4cf78f5.r28.cpolar.top/api/v1';

// æœ¬åœ°å¼€å‘ç‰ˆæœ¬ï¼ˆå·²æ³¨é‡Šï¼‰
//const BASE_URL = 'http://192.168.0.103:3000/api/v1';
```

---

## ä¸‰ã€Vite é…ç½®ä¿®æ”¹

### 3.1 æ–‡ä»¶ï¼š`frontend/vite.config.ts`

**é—®é¢˜**ï¼šé€šè¿‡ cpolar å†…ç½‘ç©¿é€è®¿é—® H5 é¡µé¢æ—¶ï¼ŒVite æ‹’ç»å¤–éƒ¨ä¸»æœºè®¿é—®ï¼Œæç¤º "Blocked request. This host is not allowed."

**ä¿®æ”¹å†…å®¹**ï¼š

```typescript
// ä¿®æ”¹å‰
export default defineConfig({
    plugins: [uni()],
    server: {
        port: 5173,
        proxy: {
            '/api': {
                target: 'http://localhost:3000',
                changeOrigin: true,
            },
        },
    },
});

// ä¿®æ”¹å
export default defineConfig({
    plugins: [uni()],
    server: {
        port: 5173,
        host: true, // å…è®¸å¤–éƒ¨è®¿é—®
        allowedHosts: [
            '18bc9de.r28.cpolar.top', // cpolar å†…ç½‘ç©¿é€åŸŸå
            '.cpolar.top', // å…è®¸æ‰€æœ‰ cpolar å­åŸŸå
        ],
        proxy: {
            '/api': {
                target: 'http://localhost:3000',
                changeOrigin: true,
            },
        },
    },
});
```

---

## å››ã€åç«¯ CORS é…ç½®

### 4.1 æ–°å¢æ–‡ä»¶ï¼š`backend/middleware.ts`

**é—®é¢˜**ï¼šè·¨åŸŸè¯·æ±‚ï¼ˆCORSï¼‰éœ€è¦å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚

**æ–°å¢å†…å®¹**ï¼š

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

// CORS ä¸­é—´ä»¶ - å¤„ç†è·¨åŸŸè¯·æ±‚
export function middleware(request: NextRequest) {
    // å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚
    if (request.method === 'OPTIONS') {
        return new NextResponse(null, {
            status: 200,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Requested-With',
                'Access-Control-Max-Age': '86400',
            },
        });
    }

    // å¯¹äºå…¶ä»–è¯·æ±‚ï¼Œæ·»åŠ  CORS å“åº”å¤´
    const response = NextResponse.next();
    response.headers.set('Access-Control-Allow-Origin', '*');
    response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');

    return response;
}

// é…ç½®ä¸­é—´ä»¶åŒ¹é…çš„è·¯å¾„
export const config = {
    matcher: '/api/:path*',
};
```

### 4.2 æ–‡ä»¶ï¼š`backend/src/lib/response.ts`

**é—®é¢˜**ï¼šAPI å“åº”éœ€è¦åŒ…å« CORS å¤´

**ä¿®æ”¹å†…å®¹**ï¼š

```typescript
// æ–°å¢ CORS å“åº”å¤´å¸¸é‡
const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Requested-With',
};

// æ–°å¢ OPTIONS å“åº”å‡½æ•°
export function options(): NextResponse {
    return new NextResponse(null, {
        status: 200,
        headers: corsHeaders,
    });
}

// ä¿®æ”¹ success å‡½æ•°ï¼Œæ·»åŠ  CORS å¤´
export function success<T>(data: T, message: string = 'success'): NextResponse<ApiResponse<T>> {
    return NextResponse.json(
        {
            code: 200,
            message,
            data,
        },
        { headers: corsHeaders }
    );
}

// ä¿®æ”¹ error å‡½æ•°ï¼Œæ·»åŠ  CORS å¤´
export function error(message: string, code: number = 400): NextResponse<ApiResponse<null>> {
    return NextResponse.json(
        {
            code,
            message,
            data: null,
        },
        { status: code >= 500 ? code : 200, headers: corsHeaders }
    );
}

// ä¿®æ”¹ paginatedSuccess å‡½æ•°ï¼Œæ·»åŠ  CORS å¤´
export function paginatedSuccess<T>(...) {
    return NextResponse.json(
        { ... },
        { headers: corsHeaders }
    );
}
```

### 4.3 æ‰€æœ‰ API è·¯ç”±æ–‡ä»¶æ·»åŠ  OPTIONS å¤„ç†

**ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨**ï¼š
- `backend/src/app/api/v1/quick-tag/route.ts`
- `backend/src/app/api/v1/record/route.ts`
- `backend/src/app/api/v1/record/[id]/route.ts`
- `backend/src/app/api/v1/quick-tag/[id]/detail/route.ts`
- `backend/src/app/api/v1/quick-tag/[id]/details/route.ts`
- `backend/src/app/api/v1/quick-tag/detail/[detailId]/route.ts`

**ç»Ÿä¸€æ·»åŠ çš„å†…å®¹**ï¼š

```typescript
import { success, error, options } from '@/lib/response';

// OPTIONS - å¤„ç† CORS é¢„æ£€è¯·æ±‚
export async function OPTIONS() {
    return options();
}
```

---

## äº”ã€é—®é¢˜æ€»ç»“

| åºå· | é—®é¢˜æè¿° | é”™è¯¯ä¿¡æ¯ | æ ¹æœ¬åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|----------|----------|
| 1 | å¾®ä¿¡å¼€å‘è€…å·¥å…·æŠ¥é”™ | `Cannot read property 'getPreCompileOptions' of undefined` | AppID é…ç½®æ— æ•ˆæˆ–ç¼ºå¤± | ä½¿ç”¨æµ‹è¯•å·æˆ–é…ç½®æ­£ç¡®çš„ AppID |
| 2 | å°ç¨‹åºæ— æ³•åŠ è½½æ•°æ® | ç½‘ç»œè¯·æ±‚å¤±è´¥ | API IP åœ°å€ `192.168.0.101` ä¸å®é™… `192.168.0.103` ä¸åŒ¹é… | æ›´æ–° BASE_URL ä¸ºæ­£ç¡®çš„ IP åœ°å€ |
| 3 | H5 å¤–ç½‘è®¿é—®è¢«æ‹¦æˆª | `Blocked request. This host is not allowed.` | Vite å®‰å…¨ç­–ç•¥ç¦æ­¢å¤–éƒ¨ä¸»æœºè®¿é—® | æ·»åŠ  cpolar åŸŸååˆ° `allowedHosts` é…ç½® |
| 4 | H5 å¤–ç½‘ API è¯·æ±‚å¤±è´¥ | `Mixed Content: ... request has been blocked` | HTTPS é¡µé¢è¯·æ±‚ HTTP èµ„æº | å°† API BASE_URL ä» `http://` æ”¹ä¸º `https://` |

---

## å…­ã€å½“å‰æœåŠ¡é…ç½®

### 6.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ

| æœåŠ¡ | åœ°å€ |
|------|------|
| MySQL æ•°æ®åº“ | localhost:3306 |
| åç«¯ API | http://localhost:3000 |
| H5 å‰ç«¯ | http://localhost:5173 |
| å¾®ä¿¡å°ç¨‹åº | å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼ˆå¯¼å…¥ dist/dev/mp-weixinï¼‰ |

### 6.2 å¤–ç½‘æµ‹è¯•ç¯å¢ƒï¼ˆcpolar å†…ç½‘ç©¿é€ï¼‰

| æœåŠ¡ | åœ°å€ |
|------|------|
| åç«¯ API | https://4cf78f5.r28.cpolar.top |
| H5 å‰ç«¯ | https://18bc9de.r28.cpolar.top |

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹

1. **cpolar å…è´¹ç‰ˆåœ°å€ä¼šå˜åŒ–**ï¼šæ¯æ¬¡é‡å¯ cpolarï¼Œåˆ†é…çš„åŸŸåå¯èƒ½ä¼šå˜åŒ–ï¼Œéœ€è¦ç›¸åº”æ›´æ–° `frontend/src/api/index.ts` ä¸­çš„ `BASE_URL`

2. **åˆ‡æ¢å¼€å‘/æµ‹è¯•ç¯å¢ƒ**ï¼šåœ¨æœ¬åœ°å¼€å‘å’Œå¤–ç½‘æµ‹è¯•ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œéœ€è¦ä¿®æ”¹ `BASE_URL` é…ç½®

3. **é‡å¯æœåŠ¡ç”Ÿæ•ˆ**ï¼šä¿®æ”¹é…ç½®åéœ€è¦é‡å¯ç›¸åº”çš„æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ

4. **HTTPS è¦æ±‚**ï¼šå¤–ç½‘è®¿é—®æ—¶ï¼Œå¦‚æœå‰ç«¯ä½¿ç”¨ HTTPSï¼Œåˆ™ API ä¹Ÿå¿…é¡»ä½¿ç”¨ HTTPSï¼Œå¦åˆ™ä¼šè§¦å‘ Mixed Content é”™è¯¯
