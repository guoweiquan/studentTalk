# 微信小程序外网测试设置方法

> 适用场景：本地开发环境，没有域名和服务器，需要让异地团队成员访问测试

---

## 整体架构

```
┌─────────────────┐     ┌──────────────┐     ┌─────────────────┐
│  您的电脑       │     │   cpolar     │     │  团队成员手机    │
│  后端 :3000     │ ───▶│   内网穿透    │ ───▶│   微信小程序     │
│  前端开发工具    │     │              │     │   体验版        │
└─────────────────┘     └──────────────┘     └─────────────────┘
```

---

## 步骤一：安装内网穿透工具

推荐使用以下工具之一（国内推荐 cpolar 或 natapp）：

### 方案 A：cpolar（推荐，国内服务稳定）

1. 访问 [cpolar 官网](https://www.cpolar.com/) 注册账号
2. 下载 Windows 版本并安装
3. 安装完成后打开命令行，配置认证 token：

```powershell
cpolar authtoken <您的token>
# token 在 cpolar 控制台 "验证" 页面获取
```

### 方案 B：natapp（国内免费）

1. 访问 [natapp 官网](https://natapp.cn/) 注册账号
2. 下载客户端
3. 购买免费隧道（需实名认证）

### 方案 C：ngrok（国际服务）

1. 访问 [ngrok 官网](https://ngrok.com/) 注册
2. 下载安装
3. 配置 authtoken

> ⚠️ ngrok 服务器在国外，国内访问可能较慢

---

## 步骤二：启动本地后端服务

确保您的后端服务已正常启动，本项目后端运行在 `http://localhost:3000`

```powershell
# 进入后端目录
cd d:\Code_Repository\studentTalk\backend

# 启动后端服务
npm run dev
```

---

## 步骤三：启动内网穿透

以 cpolar 为例：

```powershell
cpolar http 3000
```

启动成功后会显示类似以下信息：

```
Tunnel Status    online
Version          x.x.x
Forwarding       https://xxxxxxxx.cpolar.cn -> http://localhost:3000
```

**记录下这个公网地址**，如：`https://xxxxxxxx.cpolar.cn`

---

## 步骤四：修改前端 API 配置

编辑文件 `frontend/src/api/index.ts`，将 `BASE_URL` 改为 cpolar 提供的 HTTPS 地址：

```typescript
// 修改前（本地开发）
// const BASE_URL = 'http://192.168.0.101:3000/api/v1';

// 修改后（内网穿透地址）
const BASE_URL = 'https://xxxxxxxx.cpolar.cn/api/v1';
```

> ⚠️ 注意：免费版每次启动 cpolar 地址都会变化，需要重新修改

---

## 步骤五：微信开发者工具设置

由于内网穿透地址不是已备案的正式域名，需要关闭域名校验：

1. 打开 **微信开发者工具**
2. 点击右上角 **「详情」** 按钮
3. 切换到 **「本地设置」** 选项卡
4. 勾选 ✅ **「不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书」**

---

## 步骤六：上传代码并设置体验版

### 6.1 上传代码

1. 在微信开发者工具中点击工具栏的 **「上传」** 按钮
2. 填写版本号（如 `1.0.0`）
3. 填写项目备注（如"内网穿透测试版"）
4. 点击 **「上传」** 确认

### 6.2 设置体验版

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用管理员微信扫码登录
3. 进入 **「管理」** → **「版本管理」**
4. 在 **「开发版本」** 中找到刚才上传的版本
5. 点击该版本右侧的 **「设为体验版」** 按钮

### 6.3 获取体验版二维码

设置完成后，可以在同一页面看到体验版二维码，保存下来分享给团队成员。

---

## 步骤七：添加体验成员

1. 在微信公众平台中，进入 **「成员管理」**
2. 点击 **「体验成员」** → **「添加成员」**
3. 输入团队成员的微信号
4. 团队成员会收到邀请，确认后即可成为体验成员

> 📌 体验成员数量限制：个人账号最多 15 人，企业账号更多

---

## 步骤八：团队成员操作指南

请将以下内容发送给团队成员：

### 8.1 扫码进入小程序

使用微信扫描体验版二维码，进入小程序。

### 8.2 开启开发调试模式（重要！）

由于使用的是非正式域名，需要开启调试模式：

1. 进入小程序后，点击右上角 **「...」** 按钮
2. 点击 **「开发调试」**
3. 选择 **「打开调试」**
4. 小程序会重新加载，此时接口请求才能正常工作

> ⚠️ 如果不开启调试模式，接口请求会失败！

---

## 注意事项

| 事项 | 说明 |
|------|------|
| **保持服务运行** | 您本地的后端服务和 cpolar 都要一直保持运行状态 |
| **免费版地址会变** | cpolar/ngrok 免费版每次重启地址都会改变，需要重新修改代码并上传 |
| **付费可固定域名** | cpolar 付费版（约 ¥10/月）可获得固定二级域名 |
| **调试模式必须开** | 体验成员必须开启「开发调试」才能访问非备案域名 |
| **网络环境** | 确保您的电脑网络稳定，断网会导致内网穿透中断 |

---

## 常见问题

### Q1: 团队成员反馈接口请求失败？

**解决方案**：
- 确认团队成员已开启「开发调试」模式
- 确认您本地的后端服务正在运行
- 确认 cpolar 正在运行且地址正确
- 检查前端 `BASE_URL` 配置是否正确

### Q2: cpolar 地址变了怎么办？

**解决方案**：
- 修改 `frontend/src/api/index.ts` 中的 `BASE_URL`
- 重新上传代码到微信开发者工具
- 团队成员需要重新进入小程序

### Q3: 如何固定内网穿透地址？

**解决方案**：
- 购买 cpolar 付费版，可获得固定域名
- 或者使用 natapp 的付费隧道
- 自建 frp 服务（需要有公网服务器）

---

## 快速检查清单

在让团队成员测试前，请确认以下事项：

- [ ] 后端服务已启动（`npm run dev`）
- [ ] cpolar 内网穿透已启动
- [ ] 前端 `BASE_URL` 已更新为 cpolar 地址
- [ ] 微信开发者工具已关闭域名校验
- [ ] 代码已上传并设为体验版
- [ ] 团队成员已添加为体验成员
- [ ] 已通知团队成员开启「开发调试」模式
