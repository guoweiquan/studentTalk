# 本地部署方案

> 老师-学生谈话记录小程序 本地开发环境搭建指南

---

## 环境要求

在开始部署前，请确保您的电脑已安装以下软件：

| 软件 | 版本要求 | 下载地址 |
| :--- | :--- | :--- |
| **Node.js** | 20.x 或更高 | https://nodejs.org/ |
| **Docker Desktop** | 最新版本 | https://www.docker.com/products/docker-desktop/ |
| **微信开发者工具** | 最新稳定版 | https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html |
| **Git** | 最新版本 | https://git-scm.com/ |

### 验证安装

打开终端（PowerShell 或 CMD），执行以下命令验证安装：

```bash
node -v        # 应显示 v20.x.x 或更高
npm -v         # 应显示 10.x.x 或更高
docker -v      # 应显示 Docker version 2x.x.x
```

---

## 一、启动数据库

### 1.1 启动 Docker Desktop

确保 Docker Desktop 已启动并运行（系统托盘应显示 Docker 图标）。

### 1.2 启动 MySQL 容器

在项目根目录下执行：

```bash
cd d:\Code_Repository\studentTalk
docker-compose up -d mysql
```

### 1.3 验证数据库启动

等待约 30 秒后，执行以下命令验证：

```bash
docker ps
```

应看到 `talk-record-mysql` 容器正在运行。

**验证数据库连接：**

```bash
docker exec -it talk-record-mysql mysql -uapp -papp123456 -e "SHOW TABLES FROM talk_record;"
```

应显示三个表：`talk_record`、`quick_tag`、`quick_tag_detail`

### 1.4 数据库连接信息

| 参数 | 值 |
| :--- | :--- |
| 主机 | localhost |
| 端口 | 3306 |
| 数据库名 | talk_record |
| 用户名 | app |
| 密码 | app123456 |
| Root 密码 | root123456 |

---

## 二、启动后端服务

### 2.1 安装依赖

```bash
cd d:\Code_Repository\studentTalk\backend
npm install
```

### 2.2 生成 Prisma Client

```bash
npx prisma generate
```

### 2.3 同步数据库模型（可选）

如果数据库表结构与 Prisma schema 不一致，可执行：

```bash
npx prisma db push
```

### 2.4 启动开发服务器

```bash
npm run dev
```

服务将在 http://localhost:3000 启动。

### 2.5 验证后端服务

访问以下地址验证 API 正常工作：

- **首页**: http://localhost:3000
- **快捷标签 API**: http://localhost:3000/api/v1/quick-tag
- **记录列表 API**: http://localhost:3000/api/v1/record

---

## 三、启动前端服务

### 3.1 安装依赖

```bash
cd d:\Code_Repository\studentTalk\frontend
npm install
```

### 3.2 方式一：H5 开发模式（推荐测试用）

```bash
npm run dev:h5
```

浏览器访问 http://localhost:5173 即可预览。

**注意：** H5 模式可以快速测试大部分功能，但某些小程序特有 API 可能不可用。

### 3.3 方式二：微信小程序模式

#### 步骤 1：编译小程序

```bash
npm run dev:mp-weixin
```

#### 步骤 2：打开微信开发者工具

1. 打开微信开发者工具
2. 选择「小程序」→「导入项目」
3. 目录选择：`d:\Code_Repository\studentTalk\frontend\dist\dev\mp-weixin`
4. AppID 使用测试号或填入您的小程序 AppID
5. 点击「导入」

#### 步骤 3：配置请求域名

在微信开发者工具的「详情」→「本地设置」中：
- ✅ 勾选「不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书」

这样才能在开发环境访问 `localhost:3000` 的 API。

---

## 四、API 配置说明

### 4.1 前端 API 地址配置

API 基础地址配置在 `frontend/src/api/index.ts` 文件中：

```typescript
const BASE_URL = 'http://localhost:3000/api/v1';
```

**如需修改后端端口或部署到服务器，请修改此处。**

### 4.2 后端数据库配置

数据库连接配置在 `backend/.env` 文件中：

```env
DATABASE_URL="mysql://app:app123456@localhost:3306/talk_record"
```

---

## 五、完整启动流程（一键脚本）

为方便操作，可在项目根目录创建启动脚本：

### Windows (start.bat)

```batch
@echo off
echo ===== 启动数据库 =====
docker-compose up -d mysql
timeout /t 10

echo ===== 启动后端 =====
cd backend
start cmd /k "npm run dev"
cd ..

echo ===== 启动前端 (H5) =====
cd frontend
start cmd /k "npm run dev:h5"
cd ..

echo ===== 全部服务已启动 =====
echo 数据库: localhost:3306
echo 后端: http://localhost:3000
echo 前端: http://localhost:5173
pause
```

---

## 六、常见问题

### Q1: Docker 启动失败？

**检查项：**
1. Docker Desktop 是否已启动？
2. 是否已开启虚拟化（BIOS 设置）？
3. 端口 3306 是否被占用？

**查看 Docker 日志：**
```bash
docker logs talk-record-mysql
```

### Q2: 后端启动报错 "Cannot find module '@prisma/client'"？

**解决方案：**
```bash
cd backend
npx prisma generate
```

### Q3: 前端访问 API 报错 "Network Error"？

**检查项：**
1. 后端服务是否已启动？
2. 访问 http://localhost:3000 是否正常？
3. 微信开发者工具是否勾选了「不校验合法域名」？

### Q4: 数据库连接失败？

**检查 MySQL 容器状态：**
```bash
docker ps -a
```

如果容器未运行，重新启动：
```bash
docker-compose down
docker-compose up -d mysql
```

### Q5: TabBar 图标不显示？

微信小程序的 TabBar 图标需要使用 PNG 格式。如需修改，请：
1. 将 SVG 图标转换为 PNG (81x81 像素)
2. 更新 `frontend/src/pages.json` 中的图标路径

---

## 七、开发调试技巧

### 查看后端 API 日志

后端开发服务已开启详细日志，可在终端查看所有请求和 SQL 查询。

### 数据库可视化管理

推荐使用以下工具连接 MySQL：
- **Navicat**: 商业软件，功能强大
- **DBeaver**: 免费开源，跨平台
- **HeidiSQL**: 免费，Windows 专用

连接信息见上文「1.4 数据库连接信息」。

### Prisma Studio（数据库 GUI）

```bash
cd backend
npx prisma studio
```

将在浏览器打开可视化数据管理界面。

---

## 八、停止服务

### 停止后端/前端

在对应终端按 `Ctrl + C`。

### 停止数据库

```bash
cd d:\Code_Repository\studentTalk
docker-compose down
```

**如需保留数据卷：**
```bash
docker-compose stop mysql
```

**清除所有数据重新开始：**
```bash
docker-compose down -v
docker-compose up -d mysql
```

---

## 总结

| 服务 | 地址 | 启动命令 |
| :--- | :--- | :--- |
| MySQL 数据库 | localhost:3306 | `docker-compose up -d mysql` |
| 后端 API | http://localhost:3000 | `cd backend && npm run dev` |
| 前端 H5 | http://localhost:5173 | `cd frontend && npm run dev:h5` |
| 前端小程序 | 微信开发者工具 | `cd frontend && npm run dev:mp-weixin` |
