# 老师-学生谈话记录小程序 设计方案

> **版本**: v1.7  
> **更新日期**: 2026-01-31  
> **状态**: 设计阶段

---

## 1. 项目概述

### 1.1 项目背景
本项目旨在为教师提供一个简单高效的工具，用于记录与学生的谈话内容。通过模板化的方式自动生成规范的谈话记录文本，支持历史记录查询，帮助教师提升工作效率。

### 1.2 核心功能
| 功能模块 | 描述 |
| :--- | :--- |
| 新增记录 | 录入关键要素，生成规范的《学生谈话记录表》并保存 |
| 快捷标签管理 | 配置各字段的备选标签，支持分号分隔批量录入 |
| 记录列表 | 按姓名搜索，分页展示历史记录 |
| 记录详情 | 查看完整记录，支持复制、删除操作 |



### 1.3 角色设定与任务定位
- 角色：你是一位拥有20年经验的资深班主任与学生心理辅导专家
- 任务：帮助教师快速录入和管理结构化的《学生谈话记录表》，并给出专业的后续建议

### 1.4 核心变更点
- ✅ 新增"快捷标签"一键补全能力（可配置推荐词库）
- ✅ 采用**模板拼接方式**输出规范记录文本（非自由生成）
- ✅ 去除登录与新用户注册功能
- ✅ 包含「新增」「列表」「详情」「快捷标签配置」四个核心页面

### 1.5 v1.2 版本变更点
- ✅ **表单字段交互优化**：参与人、事由/问题、学生表现、原因分析、处置结果改为**复选框+自定义输入**
- ✅ **风险等级单选框**：风险等级改为单选框（低/中/高固定选项）
- ✅ **新增快捷标签配置页**：采用列表管理模式，支持单个添加和删除标签
- ✅ **数据库设计优化**：采用主表(`quick_tag`)+明细表(`quick_tag_detail`)的一对多结构，明细表支持`is_active`状态字段
- ✅ **API接口优化**：支持按类别获取/添加/删除标签明细
- ✅ **数据联动**：快捷标签配置页的内容自动同步到新增记录页的复选框选项

### 1.6 v1.3 版本变更点
- ✅ **移除"关键事实"字段**：简化表单，移除关键事实输入项
- ✅ **移除"后续跟进计划"字段**：简化表单，移除后续跟进计划及相关快捷标签类别
- ✅ **字段重命名**："学生态度/情绪"改为"学生表现"，"处理与辅导措施"改为"处置结果"
- ✅ **新增"谈话记录"字段**：在风险等级下方新增Textarea类型的"谈话记录"字段，用于记录详细谈话内容
- ✅ **数据库新增字段**：`talk_record`表新增`talk_content`字段（TEXT类型）
- ✅ **移除"原始谈话片段"功能**：简化流程，直接填写结构化表单

### 1.7 v1.4 版本变更点
- ✅ **新增"场景"选择框**：在新增记录页"参与人"上方新增"场景"单项选择框
- ✅ **场景选项**：学业、违纪、心理、宿舍 四个选项
- ✅ **场景联动过滤**：当选择场景时，"事由/问题、学生表现、原因分析、处置结果"会根据选中的`tag_type`过滤显示对应标签
- ✅ **默认显示所有**：场景为非必选项，默认（未选择场景时）显示所有场景的标签数据，但需去重
- ✅ **保留已选标签**：切换场景时，如果新场景没有已选中的标签选项，仍保留原来已录入的数据
- ✅ **参与人不过滤**："参与人"区域不受场景影响，始终显示所有标签数据

### 1.8 v1.5 版本变更点
- ✅ **扩展文本输入区域**：将原"谈话记录"输入区域扩展为三个独立的文本输入区域
- ✅ **新增"情况分析"字段**：新增独立的"情况分析"文本输入区域，支持语音输入和拍照识别
- ✅ **新增"处置结果"字段**：新增独立的"处置结果"文本输入区域，支持语音输入和拍照识别
- ✅ **数据库新增字段**：`talk_record`表新增`situation_analysis`和`disposal_result`字段（TEXT类型）
- ✅ **三个输入区域均支持语音和OCR**：每个文本输入区域都配备独立的"语音输入"和"拍照识别"按钮

### 1.9 v1.6 版本变更点
- ✅ **标签智能排序**：根据标签在近10天谈话记录中的使用频率自动排序
- ✅ **使用次数统计**：`quick_tag_detail.sort_order`字段记录标签被选中的次数
- ✅ **自动更新机制**：新增/修改谈话记录时，自动统计并更新相关标签的使用次数
- ✅ **排序规则**：新增记录页的标签按`sort_order`倒序排列，使用频率高的标签排在前面
- ✅ **统计范围**：仅统计近10天内的谈话记录

### 1.10 v1.7 版本变更点
- ✅ **搜索联想功能**：输入学生姓名时，实时从数据库获取匹配的学生姓名列表（去重）
- ✅ **防抖处理**：搜索输入采用300ms防抖，避免频繁请求
- ✅ **下拉联想列表**：显示匹配的学生姓名，点击可快速填入搜索框
- ✅ **记录列表单行展示**：将每条记录从3行压缩为1行显示
- ✅ **字段显示顺序**：学生姓名 → 事由 → 风险等级 → 年级 → 日期
- ✅ **响应式适配**：窄屏时自动省略部分字段，保证单行显示

## 2. 技术架构

### 2.1 技术栈总览

| 层级 | 技术选型 | 版本要求 |
| :--- | :--- | :--- |
| **前端框架** | Vue 3 + Vite | Vue 3.4+, Vite 5.x |
| **UI 组件库** | uView-Plus | 3.x |
| **小程序框架** | uni-app | 3.x |
| **后端框架** | Node.js + Next.js | Node 20+, Next.js 14+ |
| **数据库** | MySQL | 8.0+ |
| **容器化** | Docker + Docker Compose | 最新稳定版 |

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      微信小程序客户端                         │
│              (Vue 3 + Vite + uView-Plus)                    │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTPS
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     Next.js API Server                      │
│                  (Node.js + API Routes)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐                                   │
│  │     记录模块        │                                   │
│  └─────────────────────┘                                   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    MySQL 8.0 (Docker)                       │
└─────────────────────────────────────────────────────────────┘
```


### 2.3 项目目录结构

```
project/
├── frontend/                    # 前端项目 (uni-app)
│   ├── src/
│   │   ├── pages/              # 页面文件
│   │   │   ├── record-add/     # 新增记录页
│   │   │   ├── record-list/    # 记录列表页
│   │   │   ├── record-detail/  # 记录详情页
│   │   │   └── quick-tag/      # 快捷标签配置页

│   │   ├── components/         # 公共组件
│   │   ├── api/                # API 接口封装
│   │   ├── store/              # 状态管理
│   │   └── utils/              # 工具函数
│   └── package.json
│
├── backend/                     # 后端项目 (Next.js)
│   ├── src/
│   │   ├── app/
│   │   │   └── api/            # API Routes
│   │   ├── lib/                # 公共库
│   │   └── services/           # 业务逻辑层
│   ├── prisma/                 # 数据库模型
│   └── package.json
│
├── docker-compose.yml          # Docker 编排文件
└── README.md
```

---

## 3. 页面详细设计



### 3.1 新增记录页 (Add Record)

老师的核心操作页，用于记录谈话内容。


#### 页面布局
```
┌────────────────────────────────────┐
│         新增谈话记录                │
├────────────────────────────────────┤
│  基本信息                           │
│  ┌─────────────┬──────────────┐    │
│  │ * 学生姓名   │ * 学号        │    │
│  ├─────────────┼──────────────┤    │
│  │ * 班级      │ * 谈话地点    │    │
│  ├─────────────┴──────────────┤    │
│  │ 谈话时间：2026-01-28（只读） │    │
│  └────────────────────────────┘    │
├────────────────────────────────────┤
│  场景（可选）                       │
│  (○全部) (○学业) (○违纪) (○心理) (○宿舍)│
├────────────────────────────────────┤
│  参与人 *                          │
│  事由/问题 * （按场景过滤或显示全部） │
│  学生表现 * （按场景过滤或显示全部） │
│  原因分析 * （按场景过滤或显示全部） │
│  处置结果 * （按场景过滤或显示全部） │
│  风险等级 *                        │
│  谈话记录 *                        │
├────────────────────────────────────┤
│            [提交保存]               │
├────────────────────────────────────┤
│  ┌────────────────────────────┐    │
│  │ 【学生谈话记录表】           │    │
│  │ 结构化字段已填充…           │    │
│  └────────────────────────────┘    │
└────────────────────────────────────┘
```


#### 表单字段（结构化《学生谈话记录表》）
| 字段 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| 学生姓名 | Input | ✅ | 学生姓名（第1行左） |
| 学号 | Input | ✅ | 学号（第1行右） |
| 班级 | Input | ✅ | 例如：7年级2班（第2行左） |
| 谈话地点 | Input | ✅ | 办公室/教室等（第2行右） |
| 谈话时间 | Text（只读） | - | 自动显示当前系统日期，不可编辑（第3行，标签与日期同行） |
| 场景 | **Radio** | ❌ | 单选：全部/学业/违纪/心理/宿舍，默认"全部"；控制下方4个标签区域的显示过滤 |
| 参与人 | **Checkbox + Input** | ✅ | 从快捷标签加载选项，支持多选+自定义输入（不受场景影响） |
| 事由/问题 | **Checkbox + Input** | ✅ | 从快捷标签加载选项，按场景过滤显示（默认去重显示全部） |
| 学生表现 | **Checkbox + Input** | ✅ | 从快捷标签加载选项，按场景过滤显示（默认去重显示全部） |
| 原因分析 | **Checkbox + Input** | ✅ | 从快捷标签加载选项，按场景过滤显示（默认去重显示全部） |
| 处置结果 | **Checkbox + Input** | ✅ | 从快捷标签加载选项，按场景过滤显示（默认去重显示全部） |
| 风险等级 | **Radio** | ✅ | 单选：低/中/高（固定选项） |
| 谈话记录 | Textarea | ✅ | 详细的谈话内容记录（支持语音输入和拍照识别） |

#### 场景联动过滤说明

| 场景选择 | 对应 tag_type | 过滤效果 |
| :--- | :--- | :--- |
| 全部 | 不过滤 | 显示所有类型的标签，相同tag_value去重后显示 |
| 学业 | `学业` | 仅显示tag_type='学业'的标签 |
| 违纪 | `违纪` | 仅显示tag_type='违纪'的标签 |
| 心理 | `心理` | 仅显示tag_type='心理'的标签 |
| 宿舍 | `宿舍` | 仅显示tag_type='宿舍'的标签 |

**切换场景时的数据保留规则**：
- 已选中的标签不会因场景切换而丢失
- 如果新场景的标签列表中不包含某个已选中的标签，该标签仍保留在已选列表中
- 已选标签只有用户手动取消选择时才会移除


#### 谈话记录辅助输入功能

在"谈话记录"文本框下方提供两个辅助输入按钮：

```
┌─────────────────────────────────────────────────┐
│ * 谈话记录                                       │
│ ┌───────────────────────────────────────────┐   │
│ │                                            │   │
│ │  请输入详细的谈话内容记录...                  │   │
│ │                                            │   │
│ └───────────────────────────────────────────┘   │
│                                                  │
│  ┌──────────────────┐  ┌──────────────────┐    │
│  │   🎤 语音输入     │  │   📷 拍照识别     │    │
│  └──────────────────┘  └──────────────────┘    │
└─────────────────────────────────────────────────┘
```

##### 🎤 语音输入功能

| 项目 | 说明 |
|------|------|
| 技术方案 | 微信同声传译插件（免费、官方提供） |
| 插件AppID | `wx069ba97219f66d99` |
| 平台支持 | 仅微信小程序 |
| 交互流程 | 点击按钮 → 开始录音 → 再次点击停止 → 自动转文字 → 追加到文本框 |

##### 📷 拍照识别功能（OCR）

| 项目 | 说明 |
|------|------|
| 技术方案 | 百度OCR（通用文字识别-高精度版） |
| 免费额度 | 每天500次 |
| 平台支持 | 微信小程序、H5 |
| 交互流程 | 点击按钮 → 拍照/选择图片 → 上传识别 → 追加到文本框 |

##### 配置要求

1. **微信同声传译插件配置**
   - 登录微信公众平台 → 设置 → 第三方设置 → 添加插件
   - 搜索「同声传译」或输入 AppID：`wx069ba97219f66d99`

2. **百度OCR配置**
   - 注册百度AI开放平台账号：https://ai.baidu.com/
   - 创建应用获取 API Key 和 Secret Key
   - 在后端配置环境变量：`BAIDU_OCR_API_KEY` 和 `BAIDU_OCR_SECRET_KEY`

#### 复选框 + 自定义输入 UI 示例
```
+------------------------------------+
| 事由/问题                           |
| [x] 迟到  [x] 作业缺交  [ ] 打架    |
| [ ] 情绪波动  [ ] 课堂纪律          |
| +--------------------------------+ |
| | 其他：请输入自定义内容...        | |
| +--------------------------------+ |
+------------------------------------+
```

#### 字段选项数据来源
- 复选框选项从**快捷标签配置表**中动态加载
- 用户在"快捷标签"页面录入的内容会自动解析并展示为可选项
- 自定义输入的内容将与选中的复选框内容合并保存
- 数据解析规则：使用英文分号 `;` 作为分隔符，自动去除首尾空格

#### 模板生成逻辑
- 系统根据表单填写的字段信息，自动拼接生成规范的《学生谈话记录表》文本
```
【学生谈话记录表】
学生姓名：{姓名}    班级/学号：{班级/学号}
谈话时间：{谈话时间}    地点：{谈话地点}    参与人：{参与人}
谈话事由：{事由/问题}
学生表现：{学生表现}
原因分析：{原因分析}
处置结果：{处置结果}
风险等级：{风险等级}
谈话记录：{谈话记录}
记录人：{老师姓名}
```


---

### 3.2 记录列表页 (Record List)


用于查阅历史谈话记录。

#### 页面布局
```
┌────────────────────────────────────────────────────────┐
│  🔍 搜索学生姓名...                                 ✕   │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 王老五 (联想)                                     │  │
│  │ 王小明 (联想)                                     │  │
│  └──────────────────────────────────────────────────┘  │
├────────────────────────────────────────────────────────┤
│ 王老五  │  打架  │ 🟡中 │  六年3班  │  01-30          │
├────────────────────────────────────────────────────────┤
│ 黄六    │  打架  │ 🟡中 │  五年级3班 │  01-30          │
├────────────────────────────────────────────────────────┤
│ 丁四    │  旷课  │ 🟡中 │  五年1班  │  01-30          │
├────────────────────────────────────────────────────────┤
│ 王五    │  作业  │ 🟢低 │  三年级4班 │  01-29          │
├────────────────────────────────────────────────────────┤
│                   ↓ 加载更多 ↓                         │
└────────────────────────────────────────────────────────┘
```

#### 搜索联想功能

| 项目 | 说明 |
|------|------|
| 触发条件 | 用户输入关键字时 |
| 防抖处理 | 300ms 防抖，避免频繁请求 |
| 数据来源 | 从 `talk_record` 表查询 `student_name` 去重 |
| 匹配规则 | 模糊匹配（LIKE '%关键字%'） |
| 结果限制 | 最多显示 10 条建议 |
| 交互操作 | 点击联想项 → 填入搜索框 → 执行搜索 |

#### 列表项单行显示

| 优先级 | 字段 | 显示处理 | 说明 |
|--------|------|----------|------|
| 1 | 学生姓名 | 最多4字，超出截断 | 主要标识 |
| 2 | 事由 | 最多4字，超出截断 | 快速了解谈话原因 |
| 3 | 风险等级 | 彩色圆点+单字 | 🟢低 / 🟡中 / 🔴高 |
| 4 | 年级班级 | 简写显示 | 如"六年3班" |
| 5 | 日期 | MM-DD格式 | 省略年份 |

#### 功能说明
- **搜索框**：输入学生姓名进行模糊搜索，支持实时联想
- **联想下拉**：显示匹配的学生姓名列表，点击可快速选择
- **列表项**：单行显示关键信息，从左到右依次为：姓名、事由、风险、年级、日期
- **交互**：
  - 点击列表项 → 跳转至记录详情页
  - 下拉刷新、触底加载更多
  - 点击空白处关闭联想列表

---

### 3.3 记录详情页 (Record Detail)


展示单次谈话的完整档案。

#### 页面布局
```
┌────────────────────────────┐
│       ← 返回    记录详情     │
├────────────────────────────┤
│  学生姓名：张三              │
│  记录日期：2026-01-23       │
│  事    由：迟到              │
│  原    因：睡懒觉            │
│  学生表现：诚恳              │
│  处理结果：口头警告          │
├────────────────────────────┤
│  ┌────────────────────┐    │
│  │ 【谈话记录】         │    │
│  │ 谈话事由：本日针对张三 │    │
│  │ 同学迟到的行为进行了  │    │
│  │ 谈话。               │    │
│  │ 情况分析：经了解，核  │    │
│  │ 心原因为睡懒觉。谈话  │    │
│  │ 中学生表现诚恳。      │    │
│  │ 处置结果：口头警告。  │    │
│  └────────────────────┘    │
├────────────────────────────┤
│  [ 复制文本 ]   [ 删除记录 ] │
└────────────────────────────┘
```

#### 底部操作栏
| 按钮 | 功能 |
| :--- | :--- |
| 复制文本 | 将谈话记录复制到剪贴板 |
| 删除记录 | 二次确认后删除该条记录 |
| 编辑 (可选) | 跳转回新增页并回显数据 |

---

### 3.4 快捷标签配置页 (Quick Tag)

用于配置各字段的备选标签选项，采用列表管理模式，支持单个添加和删除。**标签按类型（学业、违纪、心理、宿舍）分组展示**。

#### 标签类型
| 类型 | 说明 | 颜色标识 |
| :--- | :--- | :--- |
| 学业 | 与学习相关的标签 | 灰色（默认） |
| 违纪 | 与纪律相关的标签 | 橙色 |
| 心理 | 与心理健康相关的标签 | 绿色 |
| 宿舍 | 与宿舍相关的标签 | 蓝色 |

#### 页面布局
```
┌─────────────────────────────────┐
│       快捷标签配置               │
├─────────────────────────────────┤
│  参与人                   4个标签 │
│  ┌─────────────────────────────┐│
│  │班主任 × │任课老师 × │家长 ×  ││
│  └─────────────────────────────┘│
│  ┌───────────────────┐ [添加]   │
│  │ 输入新标签值...    │          │
│  └───────────────────┘          │
│                                 │
│  学生表现                  6个标签│
│  ┌─────────────────────────────┐│
│  │  学业                        ││
│  │  ┌─────────────────────────┐││
│  │  │诚恳 × │抵触 × │配合 ×   │││
│  │  └─────────────────────────┘││
│  │  违纪                        ││
│  │  ┌─────────────────────────┐││
│  │  │紧张 × │冷漠 × │回避 ×   │││
│  │  └─────────────────────────┘││
│  │  心理                        ││
│  │  │ 暂无标签                 ││
│  │  宿舍                        ││
│  │  │ 暂无标签                 ││
│  └─────────────────────────────┘│
│  标签类型：                      │
│  (●学业) (○违纪) (○心理) (○宿舍)  │
│  ┌───────────────────┐ [添加]   │
│  │ 输入新标签值...    │          │
│  └───────────────────┘          │
│                                 │
│  事由/问题                       │
│  ... (同上布局)                  │
│                                 │
│  原因分析                        │
│  ... (同上布局)                  │
│                                 │
│  处置结果                        │
│  ... (同上布局)                  │
└─────────────────────────────────┘
```

#### 固定类别（5个）
| 类别编码 | 类别名称 | 是否支持标签类型 | 说明 |
| :--- | :--- | :--- | :--- |
| participants | 参与人 | ❌ | 谈话参与人员（不按类型分组） |
| reason | 事由/问题 | ✅ | 谈话事由或问题类型 |
| attitude | 学生表现 | ✅ | 学生在谈话中的表现 |
| analysis | 原因分析 | ✅ | 问题产生的原因 |
| measures | 处置结果 | ✅ | 采取的处理方式 |

#### 交互说明
| 操作 | 说明 |
| :--- | :--- |
| 选择标签类型 | 在添加标签前，先选择标签类型（学业/违纪/心理/宿舍） |
| 添加标签 | 在输入框输入内容，点击[添加]按钮，调用API新增明细记录 |
| 删除标签 | 点击标签的[×]按钮，调用API删除对应明细记录 |
| 分组展示 | 按标签类型分组展示，每组显示对应类型的所有标签 |

#### 功能说明
- 类别固定为5个，用户不能新增或删除类别
- "参与人"类别不支持标签类型，其他4个类别支持
- 每个类别下的标签按类型（学业、违纪、心理、宿舍）分组显示
- **同名标签可在不同类型下重复添加**（如"迟到"可同时存在于"学业"和"违纪"类型）
- **空的类型分组不显示**（只显示有标签数据的类型）
- 添加标签时需先选择标签类型，默认为"学业"
- 不同类型的标签用不同颜色区分
- 添加/删除操作实时保存到数据库
- 保存成功后，"新增记录页"的复选框选项会自动更新
- 风险等级为固定选项（低/中/高），不在此页面配置

---

## 4. 数据库设计 (MySQL 8.0)

### 4.1 谈话记录表 (`talk_record`)


| 字段名 | 类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| student_name | VARCHAR(50) | NOT NULL | 学生姓名 |

| class_name | VARCHAR(50) | NOT NULL | 班级 |
| student_no | VARCHAR(50) | NOT NULL | 学号 |
| talk_time | DATETIME | NOT NULL | 谈话时间 |
| talk_place | VARCHAR(100) | NOT NULL | 谈话地点 |
| participants | VARCHAR(200) | NOT NULL | 参与人 |
| reason | VARCHAR(200) | NOT NULL | 事由/问题 |
| form_data | JSON | NOT NULL | 结构化表单数据 |
| tags | JSON | | 快捷标签 |
| risk_level | TINYINT | DEFAULT 1 | 风险等级：1低 2中 3高 |
| talk_content | TEXT | | 谈话记录（详细内容） |
| generated_content | TEXT | | 生成的完整记录文本 |
| record_date | DATE | NOT NULL | 记录日期 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE talk_record (
    id INT PRIMARY KEY AUTO_INCREMENT,
    student_name VARCHAR(50) NOT NULL COMMENT '学生姓名',

    class_name VARCHAR(50) NOT NULL COMMENT '班级',
    student_no VARCHAR(50) NOT NULL COMMENT '学号',
    talk_time DATETIME NOT NULL COMMENT '谈话时间',
    talk_place VARCHAR(100) NOT NULL COMMENT '谈话地点',
    participants VARCHAR(200) NOT NULL COMMENT '参与人',
    reason VARCHAR(200) NOT NULL COMMENT '事由/问题',
    form_data JSON NOT NULL COMMENT '结构化表单数据',
    tags JSON COMMENT '快捷标签',
    risk_level TINYINT DEFAULT 1 COMMENT '风险等级：1低 2中 3高',
    talk_content TEXT COMMENT '谈话记录',
    generated_content TEXT COMMENT '生成的完整记录文本',
    record_date DATE NOT NULL COMMENT '记录日期',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='谈话记录表';

-- 为常用查询字段添加索引
CREATE INDEX idx_student_name ON talk_record(student_name);
CREATE INDEX idx_record_date ON talk_record(record_date);
```



### 4.2 快捷标签类别表 (`quick_tag`)

> 主表，存储5个固定的标签类别

| 字段名 | 类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 主键（流水号） |
| category_code | VARCHAR(50) | NOT NULL, UNIQUE | 类别编码 |
| category_name | VARCHAR(100) | NOT NULL | 类别名称 |
| sort_order | INT | DEFAULT 0 | 排序顺序 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE quick_tag (
    id INT PRIMARY KEY AUTO_INCREMENT,
    category_code VARCHAR(50) NOT NULL UNIQUE COMMENT '类别编码',
    category_name VARCHAR(100) NOT NULL COMMENT '类别名称',
    sort_order INT DEFAULT 0 COMMENT '排序顺序',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='快捷标签类别表';

-- 初始化5个固定类别
INSERT INTO quick_tag (category_code, category_name, sort_order) VALUES
('participants', '参与人', 1),
('reason', '事由/问题', 2),
('attitude', '学生表现', 3),
('analysis', '原因分析', 4),
('measures', '处置结果', 5);
```

### 4.3 快捷标签明细表 (`quick_tag_detail`)

> 明细表，存储每个类别下的多个标签值，与主表是一对多关系

| 字段名 | 类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 主键（流水号） |
| tag_id | INT | NOT NULL, FOREIGN KEY | 关联 quick_tag.id |
| tag_value | VARCHAR(200) | NOT NULL | 标签值 |
| tag_type | VARCHAR(20) | DEFAULT '学业' | 标签类型：学业、违纪、心理、宿舍 |
| is_active | TINYINT | DEFAULT 1 | 是否启用：1启用 0禁用 |
| sort_order | INT | DEFAULT 0 | 使用次数（近10天内被选中的次数，用于智能排序） |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE quick_tag_detail (
    id INT PRIMARY KEY AUTO_INCREMENT,
    tag_id INT NOT NULL COMMENT '关联 quick_tag.id',
    tag_value VARCHAR(200) NOT NULL COMMENT '标签值',
    tag_type VARCHAR(20) DEFAULT '学业' COMMENT '标签类型：学业、违纪、心理、宿舍',
    is_active TINYINT DEFAULT 1 COMMENT '是否启用：1启用 0禁用',
    sort_order INT DEFAULT 0 COMMENT '使用次数（近10天内被选中的次数）',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    CONSTRAINT fk_quick_tag FOREIGN KEY (tag_id) REFERENCES quick_tag(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='快捷标签明细表';

-- 为tag_id添加索引
CREATE INDEX idx_tag_id ON quick_tag_detail(tag_id);

-- 初始化默认标签数据
-- 参与人 (tag_id = 1) - 不区分标签类型
INSERT INTO quick_tag_detail (tag_id, tag_value, tag_type, sort_order) VALUES
(1, '班主任', '学业', 1),
(1, '任课老师', '学业', 2),
(1, '家长', '学业', 3),
(1, '学生', '学业', 4);

-- 事由/问题 (tag_id = 2)
INSERT INTO quick_tag_detail (tag_id, tag_value, tag_type, sort_order) VALUES
(2, '迟到', '学业', 1),
(2, '作业缺交', '学业', 2),
(2, '打架', '学业', 3),
(2, '情绪波动', '学业', 4),
(2, '课堂纪律', '学业', 5),
(2, '同伴冲突', '学业', 6);

-- 学生表现 (tag_id = 3)
INSERT INTO quick_tag_detail (tag_id, tag_value, tag_type, sort_order) VALUES
(3, '诚恳', '学业', 1),
(3, '抵触', '学业', 2),
(3, '紧张', '学业', 3),
(3, '冷漠', '学业', 4),
(3, '配合', '学业', 5),
(3, '回避', '学业', 6);

-- 原因分析 (tag_id = 4)
INSERT INTO quick_tag_detail (tag_id, tag_value, tag_type, sort_order) VALUES
(4, '作息管理', '学业', 1),
(4, '家庭原因', '学业', 2),
(4, '同伴影响', '学业', 3),
(4, '心理压力', '学业', 4),
(4, '学习困难', '学业', 5);

-- 处置结果 (tag_id = 5)
INSERT INTO quick_tag_detail (tag_id, tag_value, tag_type, sort_order) VALUES
(5, '口头警告', '学业', 1),
(5, '家校沟通', '学业', 2),
(5, '制定计划', '学业', 3),
(5, '心理辅导', '学业', 4),
(5, '转介专业', '学业', 5);
```

#### 唯一性约束说明
- 同一类别（tag_id）下，`tag_value + tag_type` 组合必须唯一
- 例如：在"事由/问题"类别下，"学业"类型可以有"迟到"，"违纪"类型也可以有"迟到"

#### 表关系图
```
quick_tag (主表)              quick_tag_detail (明细表)
+----+---------------+        +----+--------+-----------+----------+-----------+
| id | category_code |        | id | tag_id | tag_value | tag_type | is_active |
+----+---------------+        +----+--------+-----------+----------+-----------+
| 1  | participants  | ◄────┐ | 1  | 1      | 班主任     | 学业      | 1         |
| 2  | reason        |      │ | 2  | 1      | 任课老师   | 学业      | 1         |
| 3  | attitude      |      │ | 3  | 1      | 家长       | 学业      | 1         |
| 4  | analysis      |      └─| 4  | 2      | 迟到       | 学业      | 1         |
| 5  | measures      |        | 5  | 2      | 作业缺交   | 学业      | 1         |
+----+---------------+        +----+--------+-----------+----------+-----------+
         │                            │
         └──────── 1 : N ─────────────┘
```

---

## 5. API 接口设计

### 5.1 接口规范

- **基础路径**: `/api/v1`
- **认证方式**: 无（免登录）

- **响应格式**:
```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

### 5.2 接口列表

#### 记录模块


| 方法 | 路径 | 描述 | 认证 |
| :--- | :--- | :--- | :--- |
| POST | `/record` | 创建新记录 | ❌ |
| GET | `/record` | 获取记录列表 | ❌ |
| GET | `/record/:id` | 获取记录详情 | ❌ |
| PUT | `/record/:id` | 更新记录 | ❌ |
| DELETE | `/record/:id` | 删除记录 | ❌ |

#### 快捷标签模块

| 方法 | 路径 | 描述 | 认证 |
| :--- | :--- | :--- | :--- |
| GET | `/quick-tag` | 获取所有类别及其明细 | ❌ |
| GET | `/quick-tag/:id/details` | 获取指定类别的明细列表 | ❌ |
| POST | `/quick-tag/:id/detail` | 添加标签明细 | ❌ |
| DELETE | `/quick-tag/detail/:detailId` | 删除标签明细 | ❌ |


### 5.3 接口详情

#### 5.3.1 创建记录

```
POST /api/v1/record
```

**请求体**:
```json
{
  "student_name": "张三",
  "class_name": "7年级2班",
  "student_no": "202301",
  "talk_time": "2026-01-23 10:20:00",
  "talk_place": "办公室",
  "participants": "张老师、张三",
  "reason": "迟到",
  "form_data": {
    "student_behavior": "诚恳",
    "analysis": "作息管理薄弱",
    "result": "制定作息表并家校沟通"
  },
  "tags": ["迟到", "作息管理", "家校沟通"],
  "risk_level": 1,
  "talk_content": "今天与张三同学进行了谈话，针对其连续三天迟到的情况进行了沟通...",
  "record_date": "2026-01-23"
}
```


#### 5.3.2 获取记录列表

```
GET /api/v1/record?page=1&size=10&name=张三
```

**查询参数**:
| 参数 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| page | number | ❌ | 页码，默认 1 |
| size | number | ❌ | 每页条数，默认 10 |
| name | string | ❌ | 学生姓名（模糊搜索） |

#### 5.3.3 获取所有类别及其明细

```
GET /api/v1/quick-tag
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "category_code": "participants",
      "category_name": "参与人",
      "sort_order": 1,
      "details": [
        { "id": 1, "tag_value": "班主任", "is_active": 1, "sort_order": 1 },
        { "id": 2, "tag_value": "任课老师", "is_active": 1, "sort_order": 2 },
        { "id": 3, "tag_value": "家长", "is_active": 1, "sort_order": 3 }
      ]
    },
    {
      "id": 2,
      "category_code": "reason",
      "category_name": "事由/问题",
      "sort_order": 2,
      "details": [
        { "id": 4, "tag_value": "迟到", "is_active": 1, "sort_order": 1 },
        { "id": 5, "tag_value": "作业缺交", "is_active": 1, "sort_order": 2 },
        { "id": 6, "tag_value": "打架", "is_active": 1, "sort_order": 3 }
      ]
    }
  ]
}
```

#### 5.3.4 获取指定类别的明细列表

```
GET /api/v1/quick-tag/:id/details
```

**路径参数**:
| 参数 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| id | number | ✅ | 类别ID（quick_tag.id） |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "category": {
      "id": 2,
      "category_code": "reason",
      "category_name": "事由/问题"
    },
    "details": [
      { "id": 4, "tag_value": "迟到", "is_active": 1, "sort_order": 1 },
      { "id": 5, "tag_value": "作业缺交", "is_active": 1, "sort_order": 2 },
      { "id": 6, "tag_value": "打架", "is_active": 1, "sort_order": 3 }
    ]
  }
}
```

#### 5.3.5 添加标签明细

```
POST /api/v1/quick-tag/:id/detail
```

**路径参数**:
| 参数 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| id | number | ✅ | 类别ID（quick_tag.id） |

**请求体**:
```json
{
  "tag_value": "情绪波动"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "添加成功",
  "data": {
    "id": 7,
    "tag_id": 2,
    "tag_value": "情绪波动",
    "is_active": 1,
    "sort_order": 4,
    "create_time": "2026-01-24 15:00:00"
  }
}
```

#### 5.3.6 删除标签明细

```
DELETE /api/v1/quick-tag/detail/:detailId
```

**路径参数**:
| 参数 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| detailId | number | ✅ | 明细ID（quick_tag_detail.id） |

**响应示例**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

---

## 6. 部署方案

### 6.1 Docker Compose 配置

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: talk-record-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123456
      MYSQL_DATABASE: talk_record
      MYSQL_USER: app
      MYSQL_PASSWORD: app123456
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  backend:
    build: ./backend
    container_name: talk-record-backend
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: mysql://app:app123456@mysql:3306/talk_record
    depends_on:
      - mysql


volumes:
  mysql_data:
```

### 6.2 环境变量配置

| 变量名 | 描述 | 示例值 |
| :--- | :--- | :--- |
| DATABASE_URL | 数据库连接字符串 | mysql://user:pass@host:3306/db |


---

## 7. 开发计划

| 阶段 | 任务 | 预估工时 |
| :--- | :--- | :--- |
| **Phase 1** | 项目初始化、数据库搭建 | 1天 |
| **Phase 2** | 后端 API 开发（记录） | 2天 |

| **Phase 3** | 前端页面开发（3个页面） | 3天 |

| **Phase 4** | 联调测试、Bug 修复 | 1天 |
| **Phase 5** | 部署上线 | 1天 |

**总计**: 约 **8 个工作日**

---

## 附录

### A. 页面导航流程

```
启动小程序
    │
    ▼
┌─────────┐
│ 记录列表 │ ◄──────────────────┐
└────┬────┘                    │
    │ 点击新增                  │
    ▼                          │
┌─────────┐                    │
│ 新增记录 │───────────────────┤ 保存成功
└────┬────┘                    │
    │                          │
    ▼                          │
┌─────────┐                    │
│ 记录列表 │                    │
└────┬────┘                    │
    │ 点击列表项                 │
    ▼                          │
┌─────────┐                    │
│ 记录详情 │                    │
└─────────┘                    │
                               │
                               │
┌──────────────────────────────┴────────────────────────────────┐
│                     底部导航栏（Tab Bar）                       │
├─────────────────┬─────────────────┬─────────────────┬─────────┤
│    记录列表      │    新增记录      │   快捷标签配置   │         │
└─────────────────┴─────────────────┴─────────────────┴─────────┘
                                      │
                                      ▼
                              ┌───────────────┐
                              │ 快捷标签配置页 │
                              │ (配置复选框选项)│
                              └───────────────┘
```

### B. 错误码定义

| 错误码 | 描述 |
| :--- | :--- |
| 200 | 成功 |
| 400 | 请求参数错误 |

| 403 | 无权限访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
